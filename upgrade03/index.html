<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ê∑±Ê∑µ„Åã„Çâ„ÅÆËÑ±Âá∫</title>
    <style>
        :root {
            --x: 50%;
            --y: 50%;
            --size: 100px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            background: #000;
        }

        .game {
            height: 100vh;
            position: relative;
            background: radial-gradient(circle, #0a0e27 0%, #000 100%);
            overflow: hidden;
            outline: none;
        }

        .game::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: 10;
            background: radial-gradient(circle at var(--x) var(--y),
                transparent 0,
                transparent calc(var(--size) * 0.3),
                rgba(0, 0, 0, 0.6) calc(var(--size) * 0.7),
                rgba(0, 0, 0, 0.98) calc(var(--size) + 50px));
            pointer-events: none;
            transition: background 60ms ease-out;
        }

        .player {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #4dabf7, #1971c2);
            border-radius: 50%;
            border: 3px solid #74c0fc;
            box-shadow: 0 0 30px rgba(77, 171, 247, 0.8);
            z-index: 5;
        }

        .goal {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #51cf66, #2f9e44);
            border-radius: 50%;
            border: 4px solid #8ce99a;
            box-shadow: 0 0 40px rgba(81, 207, 102, 0.9);
            z-index: 5;
        }

        .wall {
            position: absolute;
            background: linear-gradient(135deg, #f03e3e, #c92a2a);
            border: 2px solid #ff6b6b;
            box-shadow: 0 0 20px rgba(240, 62, 62, 0.5);
            z-index: 3;
        }

        .star {
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #ffd43b, #fab005);
            border-radius: 50%;
            border: 2px solid #ffe066;
            box-shadow: 0 0 20px rgba(255, 212, 59, 0.8);
            z-index: 4;
            transition: opacity 0.3s;
        }

        .enemy {
            position: absolute;
            width: 35px;
            height: 35px;
            background: radial-gradient(circle, #e03131, #5c0a0a);
            border-radius: 50%;
            border: 3px solid #ff6b6b;
            box-shadow: 0 0 30px rgba(224, 49, 49, 0.9);
            z-index: 6;
        }

        .trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #862e9c, #5f3dc4);
            border-radius: 50%;
            border: 2px solid #9775fa;
            box-shadow: 0 0 25px rgba(134, 46, 156, 0.7);
            z-index: 2;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 90%, 100% { opacity: 0.3; }
            95% { opacity: 1; }
        }

        .hud {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 20;
            color: #74c0fc;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(116, 192, 252, 0.8);
        }

        .hud div {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #4dabf7;
            margin-bottom: 10px;
            min-width: 150px;
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 10px;
            color: #ffd43b;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #fab005;
            text-shadow: 0 0 10px rgba(255, 212, 59, 0.8);
        }

        .timer.warn {
            color: #ff6b6b;
            border-color: #f03e3e;
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-box {
            text-align: center;
            color: white;
            max-width: 500px;
            padding: 40px;
            background: rgba(10, 14, 39, 0.9);
            border-radius: 20px;
            border: 3px solid #4dabf7;
        }

        .modal-title {
            font-size: 48px;
            margin-bottom: 30px;
            color: #51cf66;
            text-shadow: 0 0 20px rgba(81, 207, 102, 1);
        }

        .modal-title.fail {
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255, 107, 107, 1);
        }

        .stats {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
        }

        .stats div { margin: 8px 0; }

        .btn {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #4dabf7, #1971c2);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 5px 20px rgba(77, 171, 247, 0.5);
        }

        .btn:hover { transform: scale(1.05); }

        @media (max-width:768px) {
            :root { --size: 130px; }
            .hud { font-size: 14px; }
            .timer { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="game" id="game" tabindex="0">
        <div id="maze"></div>

        <div class="hud">
            <div>‚≠ê <span id="stars">0</span>/<span id="total">0</span></div>
            <div>üíñ <span id="health">3</span></div>
            <div>üìä Level <span id="level">1</span></div>
        </div>

        <div class="timer" id="timer">60s</div>

        <div class="modal show" id="start">
            <div class="modal-box">
                <div class="modal-title">Ê∑±Ê∑µ„Åã„Çâ„ÅÆËÑ±Âá∫</div>
                <button class="btn" onclick="start()">„Çπ„Çø„Éº„Éà</button>
            </div>
        </div>

        <div class="modal" id="end">
            <div class="modal-box">
                <div class="modal-title" id="endTitle">üéâ Victory!</div>
                <div class="stats">
                    <div>‚≠ê Stars: <span id="finalStars">0</span></div>
                    <div>‚è±Ô∏è Time: <span id="finalTime">0</span>s</div>
                    <div>üìä Level: <span id="finalLevel">1</span></div>
                </div>
                <button class="btn" onclick="restart()">Play Again</button>
            </div>
        </div>
    </div>

    <script>
        const game = document.getElementById('game');
        const maze = document.getElementById('maze');
        const startModal = document.getElementById('start');
        const endModal = document.getElementById('end');

        let state = {
            run: false,
            pause: false,
            lvl: 1,
            x: 50,
            y: 50,
            hp: 3,
            stars: 0,
            total: 0,
            time: 60,
            speed: 2,
            enemies: [],
            timer: null
        };

        let player, goal, drag = false, mx = 0, my = 0;

        const audio = new (window.AudioContext || window.webkitAudioContext)();

        function sound(type) {
            const o = audio.createOscillator();
            const g = audio.createGain();
            o.connect(g);
            g.connect(audio.destination);
            const now = audio.currentTime;

            if (type === 'collect') {
                o.frequency.value = 800;
                g.gain.setValueAtTime(0.3, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                o.start(now);
                o.stop(now + 0.2);
            } else if (type === 'hit') {
                o.type = 'sawtooth';
                o.frequency.value = 200;
                g.gain.setValueAtTime(0.3, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                o.start(now);
                o.stop(now + 0.3);
            } else if (type === 'goal') {
                o.frequency.value = 400;
                o.frequency.exponentialRampToValueAtTime(800, now + 0.5);
                g.gain.setValueAtTime(0.3, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                o.start(now);
                o.stop(now + 0.5);
            }
        }

        function gen(lvl) {
            maze.innerHTML = '';
            state.enemies = [];

            player = document.createElement('div');
            player.className = 'player';
            maze.appendChild(player);

            goal = document.createElement('div');
            goal.className = 'goal';
            maze.appendChild(goal);

            if (lvl === 1) genLvl1();
            else if (lvl === 2) genLvl2();
            else genLvl3();
        }

        function genLvl1() {
            state.x = 10;
            state.y = 10;
            state.time = 60;
            setGoal(85, 85);

            // Complex maze structure
            wall(15, 10, 3, 400);
            wall(15, 10, 300, 3);
            wall(25, 25, 3, 350);
            wall(35, 40, 250, 3);
            wall(45, 45, 3, 300);
            wall(55, 60, 200, 3);
            wall(65, 20, 3, 250);
            wall(35, 70, 180, 3);
            wall(75, 15, 3, 350);
            wall(20, 80, 250, 3);

            star(20, 30);
            star(40, 25);
            star(60, 50);
            star(50, 75);
            star(80, 40);

            enemy(45, 35, 0.5);
            trap(35, 55);
            trap(65, 70);
        }

        function genLvl2() {
            state.x = 10;
            state.y = 15;
            state.time = 75;
            setGoal(80, 80);

            wall(18, 12, 3, 450);
            wall(18, 12, 350, 3);
            wall(30, 28, 3, 400);
            wall(42, 45, 280, 3);
            wall(52, 52, 3, 320);
            wall(62, 68, 220, 3);
            wall(72, 18, 3, 280);
            wall(28, 75, 200, 3);
            wall(80, 20, 3, 380);
            wall(15, 85, 300, 3);
            wall(48, 30, 150, 3);
            wall(58, 15, 3, 200);

            star(25, 35);
            star(45, 20);
            star(65, 45);
            star(55, 72);
            star(78, 35);
            star(38, 80);

            enemy(40, 40, 0.8);
            enemy(65, 25, 1);
            trap(32, 50);
            trap(58, 38);
            trap(72, 65);
        }

        function genLvl3() {
            state.x = 8;
            state.y = 8;
            state.time = 90;
            setGoal(88, 88);

            wall(16, 10, 3, 480);
            wall(16, 10, 380, 3);
            wall(28, 26, 3, 450);
            wall(40, 42, 320, 3);
            wall(50, 50, 3, 360);
            wall(60, 66, 250, 3);
            wall(70, 16, 3, 320);
            wall(25, 72, 230, 3);
            wall(78, 18, 3, 400);
            wall(12, 82, 320, 3);
            wall(45, 28, 180, 3);
            wall(55, 14, 3, 220);
            wall(32, 58, 150, 3);
            wall(68, 38, 3, 180);
            wall(22, 45, 120, 3);
            wall(85, 55, 3, 200);

            star(22, 32);
            star(38, 22);
            star(54, 38);
            star(68, 58);
            star(48, 72);
            star(82, 32);
            star(35, 78);
            star(75, 48);

            enemy(45, 30, 1.2);
            enemy(62, 48, 1.5);
            enemy(38, 62, 1);
            trap(30, 40);
            trap(52, 52);
            trap(65, 30);
            trap(42, 75);
            trap(75, 68);
        }

        function wall(l, t, w, h) {
            const el = document.createElement('div');
            el.className = 'wall';
            el.style.left = l + '%';
            el.style.top = t + '%';
            el.style.width = w + 'px';
            el.style.height = h + 'px';
            maze.appendChild(el);
        }

        function star(l, t) {
            const el = document.createElement('div');
            el.className = 'star';
            el.style.left = l + '%';
            el.style.top = t + '%';
            el.dataset.collected = '0';
            maze.appendChild(el);
            state.total++;
        }

        function enemy(x, y, spd) {
            const el = document.createElement('div');
            el.className = 'enemy';
            el.style.left = x + '%';
            el.style.top = y + '%';
            maze.appendChild(el);

            state.enemies.push({
                el, x, y, spd,
                dx: (Math.random() - 0.5) * 2,
                dy: (Math.random() - 0.5) * 2
            });
        }

        function trap(l, t) {
            const el = document.createElement('div');
            el.className = 'trap';
            el.style.left = l + '%';
            el.style.top = t + '%';
            maze.appendChild(el);
        }

        function setGoal(x, y) {
            goal.style.left = x + '%';
            goal.style.top = y + '%';
        }

        function start() {
            startModal.classList.remove('show');
            state.run = true;
            state.lvl = 1;
            state.hp = 3;
            state.stars = 0;
            load(1);
            tick();
            loop();
            game.focus();
        }

        function load(lvl) {
            state.lvl = lvl;
            state.stars = 0;
            state.total = 0;
            gen(lvl);
            update();
            spotlight();
        }

        function tick() {
            clearInterval(state.timer);
            const t = document.getElementById('timer');

            state.timer = setInterval(() => {
                if (!state.run || state.pause) return;

                state.time--;
                t.textContent = `${state.time}s`;
                t.className = state.time <= 10 ? 'timer warn' : 'timer';

                if (state.time <= 0) end(false);
            }, 1000);
        }

        function loop() {
            if (!state.run) return;

            if (!state.pause) {
                moveEnemies();
                checkEnemy();
                checkTrap();
                checkStar();
                checkGoal();
                spotlight();
            }

            requestAnimationFrame(loop);
        }

        function move(dx, dy) {
            const nx = Math.min(95, Math.max(0, state.x + dx));
            const ny = Math.min(95, Math.max(0, state.y + dy));

            player.style.left = nx + '%';
            player.style.top = ny + '%';

            if (hitWall()) {
                player.style.left = state.x + '%';
                player.style.top = state.y + '%';
                return;
            }

            state.x = nx;
            state.y = ny;
        }

        function hit(a, b) {
            return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
        }

        function hitWall() {
            const p = player.getBoundingClientRect();
            return [...document.querySelectorAll('.wall')].some(w => hit(p, w.getBoundingClientRect()));
        }

        function checkStar() {
            const p = player.getBoundingClientRect();
            document.querySelectorAll('.star').forEach(s => {
                if (s.dataset.collected === '0' && hit(p, s.getBoundingClientRect())) {
                    s.dataset.collected = '1';
                    s.style.opacity = '0';
                    state.stars++;
                    sound('collect');
                    update();
                }
            });
        }

        function checkGoal() {
            if (state.stars !== state.total) return;
            if (hit(player.getBoundingClientRect(), goal.getBoundingClientRect())) {
                sound('goal');
                if (state.lvl < 3) {
                    load(state.lvl + 1);
                } else {
                    end(true);
                }
            }
        }

        function moveEnemies() {
            state.enemies.forEach(e => {
                e.x += e.dx * e.spd;
                e.y += e.dy * e.spd;

                if (e.x < 5 || e.x > 90) e.dx *= -1;
                if (e.y < 5 || e.y > 90) e.dy *= -1;

                e.el.style.left = e.x + '%';
                e.el.style.top = e.y + '%';
            });
        }

        function checkEnemy() {
            const p = player.getBoundingClientRect();
            state.enemies.forEach(e => {
                if (hit(p, e.el.getBoundingClientRect())) damage();
            });
        }

        function checkTrap() {
            const p = player.getBoundingClientRect();
            document.querySelectorAll('.trap').forEach(t => {
                if (hit(p, t.getBoundingClientRect())) damage();
            });
        }

        function damage() {
            state.hp--;
            sound('hit');
            update();
            if (state.hp <= 0) end(false);
        }

        function update() {
            document.getElementById('stars').textContent = state.stars;
            document.getElementById('total').textContent = state.total;
            document.getElementById('health').textContent = state.hp;
            document.getElementById('level').textContent = state.lvl;
        }

        function end(win) {
            state.run = false;
            clearInterval(state.timer);

            document.getElementById('endTitle').textContent = win ? 'üéâ Victory!' : 'üíÄ Game Over';
            document.getElementById('endTitle').className = win ? 'modal-title' : 'modal-title fail';
            document.getElementById('finalStars').textContent = state.stars;
            document.getElementById('finalTime').textContent = state.time;
            document.getElementById('finalLevel').textContent = state.lvl;

            endModal.classList.add('show');
        }

        function restart() {
            endModal.classList.remove('show');
            start();
        }

        function spotlight() {
            const r = player.getBoundingClientRect();
            const c = game.getBoundingClientRect();
            const x = ((r.left + r.width / 2 - c.left) / c.width * 100);
            const y = ((r.top + r.height / 2 - c.top) / c.height * 100);
            game.style.setProperty('--x', x + '%');
            game.style.setProperty('--y', y + '%');
        }

        // Controls
        window.addEventListener('keydown', e => {
            if (!state.run) return;
            if (e.key === ' ') {
                e.preventDefault();
                state.pause = !state.pause;
            }
            const s = state.speed;
            if (e.key === 'ArrowLeft' || e.key === 'a') move(-s, 0);
            if (e.key === 'ArrowRight' || e.key === 'd') move(s, 0);
            if (e.key === 'ArrowUp' || e.key === 'w') move(0, -s);
            if (e.key === 'ArrowDown' || e.key === 's') move(0, s);
        });

        function pointerStart(e) {
            if (!state.run) return;
            drag = true;
            const pos = e.touches ? e.touches[0] : e;
            mx = pos.clientX;
            my = pos.clientY;
        }

        function pointerMove(e) {
            if (!state.run || !drag) return;
            const pos = e.touches ? e.touches[0] : e;
            const dx = (pos.clientX - mx) * 0.1;
            const dy = (pos.clientY - my) * 0.1;
            if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1) move(dx, dy);
            mx = pos.clientX;
            my = pos.clientY;
        }

        function pointerEnd() {
            drag = false;
        }

        game.addEventListener('mousedown', pointerStart);
        game.addEventListener('mousemove', pointerMove);
        game.addEventListener('mouseup', pointerEnd);
        game.addEventListener('touchstart', pointerStart);
        game.addEventListener('touchmove', pointerMove);
        game.addEventListener('touchend', pointerEnd);
    </script>
</body>
</html>
